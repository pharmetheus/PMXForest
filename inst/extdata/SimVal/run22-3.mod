;; 1. Based on: 20
;; 2. Description:
;;    Final frem21-3 model
;; 3. Label:
;;    SimVal base model
;------------------------------------------------------------------------------
$PROBLEM    run 1
$INPUT      NO ID STUDYID TAD TIME DAY AMT RATE ODV DV EVID BLQ DOSE
            FOOD FORM TYPE WT HT AGE SEX RACE ETHNIC GENO SMOK AST ALT
            BILI BMI CRCL NCI NCIL RACEL RACEL1 RACEL2 RACEL3 GENO1
            GENO2 GENO3 GENO4 FREMTYPE
$DATA      frem21-3.dir/frem_dataset.dta IGNORE=@
$SUBROUTINE ADVAN2 TRANS2
$PK
;;; FRELGENO4-DEFINITION START
IF(GENO4.EQ.0.0000E+00) FRELGENO4 = 1  ; Most common
IF(GENO4.EQ.1.0000E+00) FRELGENO4 = ( 1 + THETA(13))
;;; FRELGENO4-DEFINITION END


;;; FRELFORM-DEFINITION START
IF(FORM.EQ.1.0000E+00) FRELFORM = 1  ; Most common
IF(FORM.EQ.0.0000E+00) FRELFORM = ( 1 + THETA(12))
;;; FRELFORM-DEFINITION END

;;; FREL-RELATION START
FRELCOV     = FRELGENO4
FRELCOVTIME = FRELFORM
;;; FREL-RELATION END


;;; CLFOOD-DEFINITION START
IF(FOOD.EQ.1.0000E+00) CLFOOD = 1  ; Most common
IF(FOOD.EQ.0.0000E+00) CLFOOD = ( 1 + THETA(11))
;;; CLFOOD-DEFINITION END

CLWT    =  (WT/75)**THETA(2)
CLGENO1 = 1
CLGENO2 = 1
CLGENO3 = 1
CLGENO4 = 1
IF(GENO1.EQ.1) CLGENO1 = (1+THETA(8))
IF(GENO3.EQ.1) CLGENO3 = (1+THETA(9))
IF(GENO4.EQ.1) CLGENO4 = (1+THETA(10))

;;; CL-RELATION START
CLCOVTIME = CLFOOD
CLCOV     = CLWT*CLGENO1*CLGENO2*CLGENO3*CLGENO4
;;; CL-RELATION END


VWT   = (WT/75)**THETA(3)
VCOV  = VWT

TVFREL  = THETA(1)*FRELCOV
TVCL    = THETA(4) * CLCOV
TVV     = THETA(5) * VCOV
TVMAT   = THETA(6)
TVD1    = THETA(7)

;MU_1  = LOG(TVRUV)
MU_2  = TVD1
MU_3  = LOG(TVFREL)
MU_4  = LOG(TVCL)
MU_5  = LOG(TVV)
MU_6  = LOG(TVMAT)

;RUV   = EXP(MU_1               + ETA(1))
D1FR  = MU_2                   + ETA(2)
FREL  = FRELCOVTIME * EXP(MU_3 + ETA(3))
CL    = CLCOVTIME   * EXP(MU_4 + ETA(4))
V     = EXP(MU_5               + ETA(5))
MAT   = EXP(MU_6               + ETA(6))


D1    = MAT*(1-TVD1)
F1    = FREL
KA    = 1 / (MAT-D1)
S2    = V

     MU_7 = THETA(14)
     COV7 = MU_7 + ETA(7)
     MU_8 = THETA(15)
     COV8 = MU_8 + ETA(8)
     MU_9 = THETA(16)
     COV9 = MU_9 + ETA(9)
     MU_10 = THETA(17)
     COV10 = MU_10 + ETA(10)
     MU_11 = THETA(18)
     COV11 = MU_11 + ETA(11)
     MU_12 = THETA(19)
     COV12 = MU_12 + ETA(12)
     MU_13 = THETA(20)
     COV13 = MU_13 + ETA(13)
     MU_14 = THETA(21)
     COV14 = MU_14 + ETA(14)
     MU_15 = THETA(22)
     COV15 = MU_15 + ETA(15)
     MU_16 = THETA(23)
     COV16 = MU_16 + ETA(16)
     MU_17 = THETA(24)
     COV17 = MU_17 + ETA(17)
$ERROR
CP    = A(2)*1000 / V
IPRED = LOG(CP + 0.00001)
Y     = IPRED + EPS(1) * EXP(ETA(1))

;;;FREM CODE BEGIN COMPACT
;;;DO NOT MODIFY
     IF (FREMTYPE.EQ.100) THEN
;       AGE  1
        Y = COV7 + EPS(2)
        IPRED = COV7
     END IF
     IF (FREMTYPE.EQ.200) THEN
;       AST  1
        Y = COV8 + EPS(2)
        IPRED = COV8
     END IF
     IF (FREMTYPE.EQ.300) THEN
;       BILI  1
        Y = COV9 + EPS(2)
        IPRED = COV9
     END IF
     IF (FREMTYPE.EQ.400) THEN
;       CRCL  1
        Y = COV10 + EPS(2)
        IPRED = COV10
     END IF
     IF (FREMTYPE.EQ.500) THEN
;       BMI  1
        Y = COV11 + EPS(2)
        IPRED = COV11
     END IF
     IF (FREMTYPE.EQ.600) THEN
;       HT  1
        Y = COV12 + EPS(2)
        IPRED = COV12
     END IF
     IF (FREMTYPE.EQ.700) THEN
;       ALT  1
        Y = COV13 + EPS(2)
        IPRED = COV13
     END IF
     IF (FREMTYPE.EQ.800) THEN
;       SEX  1
        Y = COV14 + EPS(2)
        IPRED = COV14
     END IF
     IF (FREMTYPE.EQ.900) THEN
;       RACEL2  1
        Y = COV15 + EPS(2)
        IPRED = COV15
     END IF
     IF (FREMTYPE.EQ.1000) THEN
;       ETHNIC  1
        Y = COV16 + EPS(2)
        IPRED = COV16
     END IF
     IF (FREMTYPE.EQ.1100) THEN
;       NCIL  1
        Y = COV17 + EPS(2)
        IPRED = COV17
     END IF
;;;FREM CODE END COMPACT
$THETA  1 FIX ; 1. TVFREL
$THETA  0.75 FIX ; 2. WT coef on TVCL
$THETA  1 FIX ; 3. WT coef on TVV
$THETA  (0,12.7775) ; 4. TVCL
$THETA  (0,205.8) ; 5. TVV
$THETA  (0,6.52522) ; 6. TVMAT
$THETA  (0,0.616973,1) ; 7 TVD1
$THETA  (-1,1.3261) ; GENO2=1 on CL
$THETA  (-1,-0.328444) ; GENO3=1 on CL
$THETA  (-1,-0.536226) ; GENO4=1 on CL
$THETA  (-1.00,0.24118,3.00) ; CLFOOD1
$THETA  (-1.00,-0.141989,3.00) ; FRELFORM1
$THETA  (-1.00,2.6322,3.00) ; FRELGENO41
$THETA  44.1858 ; TV_AGE
 25.0496 ; TV_AST
 9.88064 ; TV_BILI
 118.753 ; TV_CRCL
 30.2788 ; TV_BMI
 169.234 ; TV_HT
 27.1634 ; TV_ALT
 1.44661 ; TV_SEX
 0.200784 ; TV_RACEL2
 0.436485 ; TV_ETHNIC
 0.148099 ; TV_NCIL
$OMEGA  0.0810938  ; 1. IIV on RUV
$OMEGA  0.0001  FIX  ;      2. D1
$OMEGA  BLOCK(15)
 0.544248  ; 2. IIV on FREL
 0.27707 0.313006  ; 3. IIV on CL
 0.145822 0.120447 0.135984  ; 4. IIV on V
 -0.0231497 0.0046092 0.0275095 0.148121  ; 5. IIV on MAT
 0.64871 0.306745 0.482199 -0.0785807 171.085  ;    BSV_AGE
 0.468828 0.159403 0.239076 0.255414 16.6783 113.205  ;    BSV_AST
 0.0640383 -0.199495 -0.0504936 -0.183263 -8.40381 -2.96932 26.4757  ;   BSV_BILI
 3.61259 3.08557 3.95452 0.971862 -119.834 -10.548 -9.1965 592.34  ;   BSV_CRCL
 0.928152 0.679616 1.00031 0.172299 21.4571 5.11796 -6.07847 79.8045 39.8441  ;    BSV_BMI
 3.60565 2.95613 3.28173 -0.0285425 -1.19784 2.03663 4.47091 53.5255 -0.519764 104.084  ;     BSV_HT
 1.11866 0.516636 0.752441 0.572488 15.0461 129.559 0.557515 23.0127 13.1751 9.41728 230.087  ;    BSV_ALT
 -0.163951 -0.125608 -0.115855 -0.00561677 -0.260306 -0.655357 -0.370496 -0.124989 -0.133345 -3.30562 -1.27734 0.247426  ;    BSV_SEX
 0.0124097 0.0139052 0.0175287 -0.00266198 -1.12388 -0.108779 0.105186 0.283526 -0.0167036 0.563822 -0.767397 0.00184832 0.16072  ; BSV_RACEL2
 -0.0507166 -0.041142 -0.0530675 0.013148 -0.960254 -0.152791 -0.00892913 -0.147243 -0.445568 -1.30429 0.736737 0.00348928 -0.0780314
 0.246283  ; BSV_ETHNIC
 0.0267143 -0.00306677 0.00745195 0.000958042 -0.0792847 1.08532 1.11939 0.131852 0.0130266 0.20058 2.34683 -0.0204169 -0.00206516 0.00598751
 0.126411  ;   BSV_NCIL
$SIGMA  0.0427349  ;     1. RUV
$SIGMA  1E-07  FIX  ;     EPSCOV
$ESTIMATION METHOD=IMPMAP AUTO=1 RANMETHOD=3P INTER NOABORT PRINT=1
            CITER=15 NOCOV=1 ISAMPEND=100 NITER=50 ISAMPLE=300 CTYPE=1
            CALPHA=0.001
$ESTIMATION METHOD=IMPMAP INTER EONLY=1 NITER=5 ISAMPLE=1000 NOCOV=0
$COVARIANCE PRINT=E UNCONDITIONAL

